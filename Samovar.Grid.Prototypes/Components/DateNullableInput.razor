@using Microsoft.AspNetCore.Components
@using System.Globalization;

<input class="@CssClass" tabindex="@TabIndex" spellcheck="false" autocomplete="off" type="text" id="@id" @onchange="OnDateChanged" value="@(date == null ? "" : date.Value.ToString("dd . MM . yy"))" />

@code
{
    [Inject]
    protected IJSRuntime JsRuntime { get; set; }

    [Parameter]
    public int TabIndex { get; set; }

    [Parameter]
    public string CssClass { get; set; }

    private DateTime? date;

    [Parameter]
    public DateTime? Date
    {
        get { return date; }
        set { date = value; }
    }


    [Parameter]
    public EventCallback<DateTime?> DateChanged { get; set; }

    string id = Guid.NewGuid().ToString();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JsRuntime.InvokeVoidAsync("ProtoFunctions.handleDateInput", id);
        }
    }

    private Task OnDateChanged(ChangeEventArgs e)
    {
        CultureInfo ci = CultureInfo.InvariantCulture;

        if (!DateTime.TryParseExact(e.Value.ToString().Replace(" ", ""), "dd.MM.yy", ci, System.Globalization.DateTimeStyles.None, out DateTime dt))
        {
            date = null;
            return DateChanged.InvokeAsync(date);
        }
        else
        {
            date = dt;
            return DateChanged.InvokeAsync(date);
        }
    }
}